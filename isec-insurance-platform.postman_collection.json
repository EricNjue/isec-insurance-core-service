{
	"info": {
		"_postman_id": "8a3e9c1d-1234-5678-90ab-cdef12345678",
		"name": "iSec Motor Insurance Platform MVP",
		"description": "Production-grade API collection for the Motor Insurance Platform.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Authentication",
			"item": [
				{
					"name": "Get Access Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"accessToken\", jsonData.access_token);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{
									"key": "grant_type",
									"value": "password",
									"type": "text"
								},
								{
									"key": "client_id",
									"value": "{{clientId}}",
									"type": "text"
								},
								{
									"key": "username",
									"value": "{{username}}",
									"type": "text"
								},
								{
									"key": "password",
									"value": "{{password}}",
									"type": "text"
								}
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/{{realm}}/protocol/openid-connect/token",
							"host": [
								"{{keycloakUrl}}"
							],
							"path": [
								"realms",
								"{{realm}}",
								"protocol",
								"openid-connect",
								"token"
							]
						},
						"description": "Obtain an access token from Keycloak using the Resource Owner Password Credentials grant."
					},
					"response": []
				}
			]
		},
		{
			"name": "Identity",
			"item": [
				{
					"name": "Get Current Profile",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/profile",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"profile"
							]
						},
						"description": "Returns the authenticated user's profile and roles from Keycloak."
					},
					"response": []
				}
			]
		},
		{
			"name": "Applications",
			"item": [
				{
					"name": "Create Application",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"registrationNumber\": \"KAA 001Z\",\n    \"vehicleMake\": \"Toyota\",\n    \"vehicleModel\": \"Corolla\",\n    \"yearOfManufacture\": 2020,\n    \"vehicleValue\": 2500000\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/applications",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"applications"
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Application by ID",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/applications/{{applicationId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"applications",
								"{{applicationId}}"
							]
						}
					},
					"response": []
				},
				{
					"name": "List Applications",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/applications",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"applications"
							]
						},
						"description": "Lists all applications for the current user. Admins see all applications."
					},
					"response": []
				},
				{
					"name": "Get Authenticated Quote",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/applications/quote?applicationId={{applicationId}}&baseRate=0.045",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"applications",
								"quote"
							],
							"query": [
								{
									"key": "applicationId",
									"value": "{{applicationId}}"
								},
								{
									"key": "baseRate",
									"value": "0.045"
								}
							]
						},
						"description": "Calculates the final premium for an application, creates the policy record, and transitions application status to QUOTED."
					},
					"response": []
				}
			]
		},
		{
			"name": "Rating",
			"item": [
				{
					"name": "Anonymous Quote",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"vehicleMake\": \"Toyota\",\n    \"vehicleModel\": \"Vitz\",\n    \"yearOfManufacture\": 2018,\n    \"vehicleValue\": 1200000,\n    \"baseRate\": 0.04\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/rating/anonymous-quote",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"rating",
								"anonymous-quote"
							]
						},
						"description": "Calculates a quote without requiring authentication or a pre-existing application. Returns an anonymousQuoteId stored in Redis."
					},
					"response": []
				},
				{
					"name": "Calculate Premium",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/rating/calculate?vehicleValue=2000000&baseRate=0.045",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"rating",
								"calculate"
							],
							"query": [
								{
									"key": "vehicleValue",
									"value": "2000000"
								},
								{
									"key": "baseRate",
									"value": "0.045"
								}
							]
						},
						"description": "Authenticated endpoint to calculate premium breakdown based on provided values."
					},
					"response": []
				}
			]
		},
		{
			"name": "Documents",
			"item": [
				{
					"name": "Get Application Documents",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/documents/application/{{applicationId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"documents",
								"application",
								"{{applicationId}}"
							]
						},
						"description": "Returns all mandatory documents for the application with their current presigned GET URLs."
					},
					"response": []
				},
				{
					"name": "Get Upload Presigned URL",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"pm.environment.set(\"presignedUploadUrl\", jsonData.presignedUrl);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/documents/presigned-url?documentType=LOGBOOK&applicationId={{applicationId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"documents",
								"presigned-url"
							],
							"query": [
								{
									"key": "documentType",
									"value": "LOGBOOK"
								},
								{
									"key": "applicationId",
									"value": "{{applicationId}}"
								}
							]
						},
 					"description": "Returns a PUT presigned URL for uploading a specific document type for an application."
					},
					"response": []
				},
				{
					"name": "Upload Document to S3",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/pdf",
								"type": "text"
							}
						],
						"body": {
							"mode": "file",
							"file": {
								"src": ""
							}
						},
						"url": {
							"raw": "{{presignedUploadUrl}}",
							"host": [
								"{{presignedUploadUrl}}"
							]
						},
						"description": "Uses the presigned URL obtained from 'Get Upload Presigned URL' to upload the document directly to S3. Note: The URL is passed as a variable 'presignedUploadUrl' which you should set from the previous request's response."
					},
					"response": []
				}
			]
		},
		{
			"name": "Payments",
			"item": [
				{
					"name": "Initiate STK Push",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "X-Idempotency-Key",
								"value": "{{$guid}}",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"applicationId\": {{applicationId}},\n    \"amount\": 10000,\n    \"phoneNumber\": \"254700000000\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/payments/stk-push",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"payments",
								"stk-push"
							]
						}
					},
					"response": []
				},
				{
					"name": "M-Pesa Callback Mock",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"Body\": {\n        \"stkCallback\": {\n            \"MerchantRequestID\": \"29115-346271-1\",\n            \"CheckoutRequestID\": \"ws_CO_191220191020363925\",\n            \"ResultCode\": 0,\n            \"ResultDesc\": \"The service was accepted successfully\",\n            \"CallbackMetadata\": {\n                \"Item\": [\n                    {\n                        \"Name\": \"Amount\",\n                        \"Value\": 10000.00\n                    },\n                    {\n                        \"Name\": \"MpesaReceiptNumber\",\n                        \"Value\": \"NLJ7RT61AS\"\n                    },\n                    {\n                        \"Name\": \"Balance\",\n                        \"Value\": 0.00\n                    },\n                    {\n                        \"Name\": \"TransactionDate\",\n                        \"Value\": 20191219102022\n                    },\n                    {\n                        \"Name\": \"PhoneNumber\",\n                        \"Value\": 254708374149\n                    }\n                ]\n            }\n        }\n    }\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/payments/callback",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"payments",
								"callback"
							]
						},
						"description": "Mock request for M-Pesa STK Push callback. This endpoint is typically called by Safaricom asynchronously after an STK push is initiated."
					},
					"response": []
				}
			]
		},
		{
			"name": "Certificates",
			"item": [
				{
					"name": "Request Issuance",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/certificates/request?policyId={{policyId}}&amount=30000",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"certificates",
								"request"
							],
							"query": [
								{
									"key": "policyId",
									"value": "{{policyId}}"
								},
								{
									"key": "amount",
									"value": "30000"
								}
							]
						},
						"description": "Manually triggers the certificate issuance logic for a policy. Note: This is automatically triggered by the M-Pesa callback in a live flow."
					},
					"response": []
				},
				{
					"name": "Get Certificates by Policy",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/certificates/policy/{{policyId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"certificates",
								"policy",
								"{{policyId}}"
							]
						},
						"description": "Returns all certificates (Month 1, Month 2, Annual) associated with a policy."
					},
					"response": []
				}
			]
		},
		{
			"name": "Policies",
			"item": [
				{
					"name": "Get Policy by ID",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/policies/{{policyId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"policies",
								"{{policyId}}"
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Policy by Application ID",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/policies/application/{{applicationId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"policies",
								"application",
								"{{applicationId}}"
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Notifications",
			"item": [
				{
					"name": "Trigger Reminders",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/notifications/reminders/trigger",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"notifications",
								"reminders",
								"trigger"
							]
						},
						"description": "Admin-only endpoint to trigger policy expiry reminders."
					},
					"response": []
				},
				{
					"name": "Request Valuation Letter",
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/notifications/valuation-letter/{{policyId}}",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"notifications",
								"valuation-letter",
								"{{policyId}}"
							]
						},
						"description": "Triggers the asynchronous generation and delivery of a valuation letter for a policy."
					},
					"response": []
				}
			]
		},
		{
			"name": "Reporting",
			"item": [
				{
					"name": "Export CSV Report",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/reports/export?startDate=2024-01-01&endDate=2024-12-31",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"reports",
								"export"
							],
							"query": [
								{
									"key": "startDate",
									"value": "2024-01-01"
								},
								{
									"key": "endDate",
									"value": "2024-12-31"
								}
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Audit",
			"item": [
				{
					"name": "Fetch Audit Logs",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/audit?page=0&size=20",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"audit"
							],
							"query": [
								{
									"key": "page",
									"value": "0"
								},
								{
									"key": "size",
									"value": "20"
								}
							]
						},
						"description": "Returns a paginated list of audit logs. Admin only."
					},
					"response": []
				},
				{
					"name": "Fetch Audit Logs by Entity",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/audit/entity/APPLICATION/{{applicationId}}?page=0&size=20",
							"host": [
								"{{baseUrl}}"
							],
							"path": [
								"api",
								"v1",
								"audit",
								"entity",
								"APPLICATION",
								"{{applicationId}}"
							],
							"query": [
								{
									"key": "page",
									"value": "0"
								},
								{
									"key": "size",
									"value": "20"
								}
							]
						},
						"description": "Returns audit logs filtered by entity type and ID. Admin only."
					},
					"response": []
				}
			]
		}
	],
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{accessToken}}",
				"type": "string"
			}
		]
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "baseUrl",
			"value": "http://localhost:8080"
		},
		{
			"key": "keycloakUrl",
			"value": "http://localhost:9050"
		},
		{
			"key": "realm",
			"value": "isec-insurance"
		},
		{
			"key": "clientId",
			"value": "motor-insurance-client"
		},
		{
			"key": "username",
			"value": "retail-user"
		},
		{
			"key": "password",
			"value": "password"
		},
		{
			"key": "accessToken",
			"value": "your_jwt_here"
		},
		{
			"key": "applicationId",
			"value": "1"
		},
		{
			"key": "policyId",
			"value": "1"
		},
		{
			"key": "presignedUploadUrl",
			"value": ""
		}
	]
}
